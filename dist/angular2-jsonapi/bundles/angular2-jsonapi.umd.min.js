!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("date-fns"),require("lodash"),require("lodash-es"),require("@angular/core"),require("@angular/common/http"),require("rxjs/operators"),require("rxjs"),require("qs"),require("reflect-metadata")):"function"==typeof define&&define.amd?define("angular2-jsonapi",["exports","date-fns","lodash","lodash-es","@angular/core","@angular/common/http","rxjs/operators","rxjs","qs","reflect-metadata"],e):e((t=t||self)["angular2-jsonapi"]={},t["date-fns"],t.lodash,t["lodash-es"],t.ng.core,t.ng.common.http,t.rxjs.operators,t.rxjs,t.qs)}(this,function(t,e,r,n,i,a,o,s,l){"use strict";var u=function(){return(u=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function d(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function f(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,a=r.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(n=a.next()).done;)o.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(i)throw i.error}}return o}var p=function(){function t(t){this.nestedDataSerialization=!1,t&&Object.assign(this,t)}return Object.defineProperty(t.prototype,"modelConfig",{get:function(){return Reflect.getMetadata("JsonApiModelConfig",this.constructor)},enumerable:!0,configurable:!0}),t.prototype.fill=function(t){Object.assign(this,t)},t.prototype.serialize=function(){return this.transformSerializedNamesToPropertyNames()},t.prototype.transformSerializedNamesToPropertyNames=function(){var t=this,e=this.getModelPropertyNames(),r={};return Object.keys(e).forEach(function(n){t&&null!==t[n]&&void 0!==t[n]&&"nestedDataSerialization"!==n&&(r[e[n]]=t[n])}),r},t.prototype.getModelPropertyNames=function(){return Reflect.getMetadata("AttributeMapping",this)||[]},t}();var c={nullValue:!1,hasMany:!1},h=function(){function t(t,e){void 0===e&&(e={}),this.modelType=t,this.options=u({},c,e)}return t.prototype.mask=function(t){var e,r;if(!t&&!this.options.nullValue)return this.options.hasMany?[]:new this.modelType;var n=null;if(this.options.hasMany){if(!Array.isArray(t))throw new Error("ERROR: JsonModelConverter: Expected array but got "+typeof t+".");n=[];try{for(var i=d(t),a=i.next();!a.done;a=i.next()){var o=a.value;if(null!==o){var s=void 0;"object"==typeof o?(s=new this.modelType).fill(o):s=o,n.push(s)}}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}else t instanceof this.modelType?n=t:(n=new this.modelType).fill(t);return n},t.prototype.unmask=function(t){var e,r;if(!t)return t;var n=null;if(Array.isArray(t)){n=[];try{for(var i=d(t),a=i.next();!a.done;a=i.next()){var o=a.value;o&&(o instanceof p?(o.nestedDataSerialization=!0,n.push(o.serialize()),o.nestedDataSerialization=!1):n.push(o))}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}else t instanceof p?(t.nestedDataSerialization=!0,n=t.serialize(),t.nestedDataSerialization=!1):n=t;return n},t}();var y=Symbol("AttributeMetadata"),g=function(){function t(){}return t.prototype.mask=function(t){return"string"==typeof t?e.parseISO(t):t},t.prototype.unmask=function(t){return null===t?null:t.toISOString()},t}();var v=function(t){this.links=t.links||[],this.meta=t.meta};var b=y,m=function(){function t(t,e){this.internalDatastore=t,this.modelInitialization=!1,e&&(this.modelInitialization=!0,this.id=e.id,Object.assign(this,e.attributes),this.modelInitialization=!1)}return t.prototype.isModelInitialization=function(){return this.modelInitialization},t.prototype.syncRelationships=function(t,e,r){if(this.lastSyncModels!==e){if(t){var n=r;void 0===n&&(n=[].concat(e)),this.parseHasMany(t,e,n),this.parseBelongsTo(t,e,n)}this.lastSyncModels=e}},t.prototype.save=function(t,e,r){this.checkChanges();var n=this[b];return this.internalDatastore.saveRecord(n,this,t,e,r)},Object.defineProperty(t.prototype,"hasDirtyAttributes",{get:function(){this.checkChanges();var t=this[b],e=!1;for(var r in t){if(t.hasOwnProperty(r))if(t[r].hasDirtyAttributes){e=!0;break}}return e},enumerable:!0,configurable:!0}),t.prototype.checkChanges=function(){var t=this[y];for(var e in t){if(t.hasOwnProperty(e))t[e].nested&&(this[y][e].hasDirtyAttributes=!r.isEqual(t[e].oldValue,t[e].newValue),this[y][e].serialisationValue=t[e].converter(Reflect.getMetadata("design:type",this,e),r.cloneDeep(t[e].newValue),!0))}},t.prototype.rollbackAttributes=function(){var t=this[b];for(var e in t)t.hasOwnProperty(e)&&t[e].hasDirtyAttributes&&(this[e]=r.cloneDeep(t[e].oldValue))},Object.defineProperty(t.prototype,"modelConfig",{get:function(){return Reflect.getMetadata("JsonApiModelConfig",this.constructor)},enumerable:!0,configurable:!0}),t.prototype.parseHasMany=function(t,e,r){var i,a,o,s,l=Reflect.getMetadata("HasMany",this);if(l)try{for(var u=d(l),f=u.next();!f.done;f=u.next()){var p=f.value,c=t.relationships?t.relationships[p.relationship]:null;if(c&&c.data&&Array.isArray(c.data)){var h=[],y=[];try{for(var g=(o=void 0,d(Object.keys(c.data))),v=g.next();!v.done;v=g.next()){var b=v.value,m=c.data[b].type;if(!n.includes(y,m)){y.push(m);var M=Reflect.getMetadata("JsonApiDatastoreConfig",this.internalDatastore.constructor).models[m];if(!M)throw{message:"parseHasMany - Model type for relationship "+m+" not found."};var R=this.getHasManyRelationship(M,c.data,e,m,r);R.length>0&&(h=h.concat(R))}}}catch(t){o={error:t}}finally{try{v&&!v.done&&(s=g.return)&&s.call(g)}finally{if(o)throw o.error}}this[p.propertyName]=h}}}catch(t){i={error:t}}finally{try{f&&!f.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}},t.prototype.parseBelongsTo=function(t,e,r){var n,i,a=Reflect.getMetadata("BelongsTo",this);if(a)try{for(var o=d(a),s=o.next();!s.done;s=o.next()){var l=s.value,u=t.relationships?t.relationships[l.relationship]:null;if(u&&u.data){var f=u.data instanceof Array?u.data[0]:u.data;if(f){var p=f.type,c=Reflect.getMetadata("JsonApiDatastoreConfig",this.internalDatastore.constructor).models[p];if(!c)throw{message:"parseBelongsTo - Model type for relationship "+p+" not found."};var h=this.getBelongsToRelationship(c,f,e,p,r);h&&(this[l.propertyName]=h)}}}}catch(t){n={error:t}}finally{try{s&&!s.done&&(i=o.return)&&i.call(o)}finally{if(n)throw n.error}}},t.prototype.getHasManyRelationship=function(t,e,r,i,a){var o=this,s=[];return e.forEach(function(e){var l=n.find(r,{id:e.id,type:i});if(l){var u=o.createOrPeek(t,l),d=a.indexOf(l),f=a.concat([]);-1!==d&&(f.splice(d,1),u.syncRelationships(l,r,f)),s.push(u)}}),s},t.prototype.getBelongsToRelationship=function(t,e,r,i,a){var o=e.id,s=n.find(r,{id:o,type:i});if(s){var l=this.createOrPeek(t,s),u=a.indexOf(s),d=a.concat([]);return-1!==u&&(d.splice(u,1),l.syncRelationships(s,r,d)),l}return this.internalDatastore.peekRecord(t,o)},t.prototype.createOrPeek=function(t,e){var n=this.internalDatastore.peekRecord(t,e.id);if(n)return r.extend(n,this.internalDatastore.transformSerializedNamesToPropertyNames(t,e.attributes)),n;var i=this.internalDatastore.deserializeModel(t,e);return this.internalDatastore.addToStore(i),i},t}();var M=function(t){this.errors=[],t&&(this.errors=t)};var R=function(){function t(t,e){this.jsonApiModels=t,this.metaData=e}return t.prototype.getModels=function(){return this.jsonApiModels},t.prototype.getMeta=function(){return this.metaData},t}();var A=y,D=function(){function t(t){this.http=t,this.globalRequestOptions={},this.internalStore={},this.toQueryString=this.datastoreConfig.overrides&&this.datastoreConfig.overrides.toQueryString?this.datastoreConfig.overrides.toQueryString:this._toQueryString}return Object.defineProperty(t.prototype,"headers",{set:function(t){this.globalHeaders=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"requestOptions",{set:function(t){this.globalRequestOptions=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"datastoreConfig",{get:function(){var t=Reflect.getMetadata("JsonApiDatastoreConfig",this.constructor);return Object.assign(t,this.config)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"getDirtyAttributes",{get:function(){return this.datastoreConfig.overrides&&this.datastoreConfig.overrides.getDirtyAttributes?this.datastoreConfig.overrides.getDirtyAttributes:t.getDirtyAttributes},enumerable:!0,configurable:!0}),t.getDirtyAttributes=function(t){var e={};for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];if(n.hasDirtyAttributes)e[null!=n.serializedName?n.serializedName:r]=n.serialisationValue?n.serialisationValue:n.newValue}return e},t.prototype.query=function(t,e,r,n){var i=this,a=this.buildHttpHeaders(r),s=this.buildUrl(t,e,void 0,n);return this.http.get(s,{headers:a}).pipe(o.map(function(e){return i.extractQueryData(e,t)}),o.catchError(function(t){return i.handleError(t)}))},t.prototype.findAll=function(t,e,r,n){var i=this,a=this.buildUrl(t,e,void 0,n),s=this.buildRequestOptions({headers:r,observe:"response"});return this.http.get(a,s).pipe(o.map(function(e){return i.extractQueryData(e,t,!0)}),o.catchError(function(t){return i.handleError(t)}))},t.prototype.findRecord=function(t,e,r,n,i){var a=this,s=this.buildRequestOptions({headers:n,observe:"response"}),l=this.buildUrl(t,r,e,i);return this.http.get(l,s).pipe(o.map(function(e){return a.extractRecordData(e,t)}),o.catchError(function(t){return a.handleError(t)}))},t.prototype.createRecord=function(t,e){return new t(this,{attributes:e})},t.prototype.saveRecord=function(t,e,r,n,i){var a=this,l=e.constructor,u=e.modelConfig.type,d=this.getRelationships(e),f=this.buildUrl(l,r,e.id,i),p={data:{relationships:d,type:u,id:e.id,attributes:this.getDirtyAttributes(t,e)}},c=this.buildRequestOptions({headers:n,observe:"response"});return(e.id?this.http.patch(f,p,c):this.http.post(f,p,c)).pipe(o.map(function(t){return-1!==[200,201].indexOf(t.status)?a.extractRecordData(t,l,e):e}),o.catchError(function(t){return null==t?s.of(e):a.handleError(t)}),o.map(function(t){return a.updateRelationships(t,d)}))},t.prototype.deleteRecord=function(t,e,r,n){var i=this,a=this.buildRequestOptions({headers:r}),s=this.buildUrl(t,null,e,n);return this.http.delete(s,a).pipe(o.catchError(function(t){return i.handleError(t)}))},t.prototype.peekRecord=function(t,e){var r=Reflect.getMetadata("JsonApiModelConfig",t).type;return this.internalStore[r]?this.internalStore[r][e]:null},t.prototype.peekAll=function(t){var e=Reflect.getMetadata("JsonApiModelConfig",t).type,r=this.internalStore[e];return r?Object.keys(r).map(function(t){return r[t]}):[]},t.prototype.deserializeModel=function(t,e){return e.attributes=this.transformSerializedNamesToPropertyNames(t,e.attributes),new t(this,e)},t.prototype.addToStore=function(t){var e,r,n=Array.isArray(t)?t:[t],i=n[0].modelConfig.type,a=this.internalStore[i];a||(a=this.internalStore[i]={});try{for(var o=d(n),s=o.next();!s.done;s=o.next()){var l=s.value;a[l.id]=l}}catch(t){e={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}},t.prototype.transformSerializedNamesToPropertyNames=function(t,e){if(!e)return{};var r=this.getModelPropertyNames(t.prototype),n={};return Object.keys(r).forEach(function(t){void 0!==e[t]&&(n[r[t]]=e[t])}),n},t.prototype.buildUrl=function(t,e,r,n){var i=this.toQueryString(e);if(n)return i?n+"?"+i:n;var a=Reflect.getMetadata("JsonApiModelConfig",t),o=[a.baseUrl||this.datastoreConfig.baseUrl,a.apiVersion||this.datastoreConfig.apiVersion,a.modelEndpointUrl||a.type,r].filter(function(t){return t}).join("/");return i?o+"?"+i:o},t.prototype.getRelationships=function(t){var e,r=this,n=Reflect.getMetadata("BelongsTo",t)||[],i=Reflect.getMetadata("HasMany",t)||[],a=function(a){if(t.hasOwnProperty(a))if(t[a]instanceof m){if(e=e||{},t[a].id){var s=(u=n.find(function(t){return t.propertyName===a})).relationship;e[s]={data:o.buildSingleRelationshipData(t[a])}}}else if(t[a]instanceof Array){if((u=i.find(function(t){return t.propertyName===a}))&&o.isValidToManyRelation(t[a])){e=e||{};s=u.relationship;var l=t[a].filter(function(t){return t.id}).map(function(t){return r.buildSingleRelationshipData(t)});e[s]={data:l}}}else if(null===t[a]){var u;(u=n.find(function(t){return t.propertyName===a}))&&((e=e||{})[u.relationship]={data:null})}},o=this;for(var s in t)a(s);return e},t.prototype.isValidToManyRelation=function(t){return!t.length||!!t.every(function(t){return t instanceof m})&&1===t.map(function(t){return t.modelConfig.modelEndpointUrl||t.modelConfig.type}).filter(function(t,e,r){return r.indexOf(t)===e}).length},t.prototype.buildSingleRelationshipData=function(t){var e={type:t.modelConfig.type};if(t.id)e.id=t.id;else{var r=Reflect.getMetadata("Attribute",t);e.attributes=this.getDirtyAttributes(r,t)}return e},t.prototype.extractQueryData=function(t,e,r){var n=this;void 0===r&&(r=!1);var i=t.body,a=[],o=function(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}(i.data,i.included||[]);return i.data.forEach(function(t){var r=n.deserializeModel(e,t);n.addToStore(r),r.syncRelationships(t,o),n.addToStore(r),a.push(r)}),r&&!0===r?new R(a,this.parseMeta(i,e)):a},t.prototype.extractRecordData=function(t,e,r){var n=t.body;if(!n||"null"===n)throw new Error("no body in response");if(!n.data){if(201===t.status||!r)throw new Error("expected data in response");return r}r&&(r.modelInitialization=!0,r.id=n.data.id,Object.assign(r,n.data.attributes),r.modelInitialization=!1);var i=r||this.deserializeModel(e,n.data);return this.addToStore(i),n.included&&(i.syncRelationships(n.data,n.included),this.addToStore(i)),i},t.prototype.handleError=function(t){if(t instanceof a.HttpErrorResponse&&t.error instanceof Object&&t.error.errors&&t.error.errors instanceof Array){var e=new M(t.error.errors);return s.throwError(e)}return s.throwError(t)},t.prototype.parseMeta=function(t,e){return new(0,Reflect.getMetadata("JsonApiModelConfig",e).meta)(t)},t.prototype.getOptions=function(t){return{headers:this.buildHttpHeaders(t)}},t.prototype.buildHttpHeaders=function(t){var e=this,r=new a.HttpHeaders({Accept:"application/vnd.api+json","Content-Type":"application/vnd.api+json"});return this.globalHeaders&&this.globalHeaders.keys().forEach(function(t){e.globalHeaders.has(t)&&(r=r.set(t,e.globalHeaders.get(t)))}),t&&t.keys().forEach(function(e){t.has(e)&&(r=r.set(e,t.get(e)))}),r},t.prototype.resetMetadataAttributes=function(t,e,r){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];i.hasDirtyAttributes&&(i.hasDirtyAttributes=!1)}return t[A]=e,t},t.prototype.updateRelationships=function(t,e){var r=Reflect.getMetadata("JsonApiDatastoreConfig",this.constructor).models;for(var i in e)if(e.hasOwnProperty(i)&&t.hasOwnProperty(i)&&t[i]){var a=t[i],o=Reflect.getMetadata("HasMany",a),s=n.find(o,function(e){return r[e.relationship]===t.constructor});if(s){a[s.propertyName]=a[s.propertyName]||[];var l=a[s.propertyName].indexOf(t);-1===l?a[s.propertyName].push(t):a[s.propertyName][l]=t}}return t},t.prototype.getModelPropertyNames=function(t){return Reflect.getMetadata("AttributeMapping",t)||[]},t.prototype.buildRequestOptions=function(t){void 0===t&&(t={});var e=this.buildHttpHeaders(t.headers),r=Object.assign(t,{headers:e});return Object.assign(this.globalRequestOptions,r)},t.prototype._toQueryString=function(t){return l.stringify(t,{arrayFormat:"brackets"})},t.decorators=[{type:i.Injectable}],t.ctorParameters=function(){return[{type:a.HttpClient}]},t}();var O=[D],w=function(){function t(){}return t.decorators=[{type:i.NgModule,args:[{providers:[O],exports:[a.HttpClientModule]}]}],t}();t.Attribute=function(t){return void 0===t&&(t={}),function(e,n){var i=function(e,r,n){var i;if(void 0===n&&(n=!1),t.converter)i=t.converter;else if(e===Date)i=new g;else{var a=new e;a.mask&&a.unmask&&(i=a)}return i?n?i.unmask(r):i.mask(r):r};delete e[n]&&(!function(){var r=Reflect.getMetadata("Attribute",e)||{};r[n]={marked:!0},Reflect.defineMetadata("Attribute",r,e);var i=Reflect.getMetadata("AttributeMapping",e)||{};i[void 0!==t.serializedName?t.serializedName:n]=n,Reflect.defineMetadata("AttributeMapping",i,e)}(),Object.defineProperty(e,n,{get:function(){return this["_"+n]},set:function(a){var o=Reflect.getMetadata("design:type",e,n),s=i(o,a),l=null;this.isModelInitialization()&&this.id?l=i(o,a):this[y]&&this[y][n]&&(l=this[y][n].oldValue),this["_"+n]=s,function(a,o,s){var l=Reflect.getMetadata("design:type",e,n);a[y]||(a[y]={}),a[y][n]={newValue:s,oldValue:o,nested:!1,serializedName:t.serializedName,hasDirtyAttributes:!r.isEqual(o,s),serialisationValue:i(l,s,!0)}}(this,l,s)},enumerable:!0,configurable:!0}))}},t.BelongsTo=function(t){return void 0===t&&(t={}),function(e,r){var n=Reflect.getMetadata("BelongsTo",e)||[];n.push({propertyName:r,relationship:t.key||r}),Reflect.defineMetadata("BelongsTo",n,e)}},t.DEFAULT_OPTIONS=c,t.ErrorResponse=M,t.HasMany=function(t){return void 0===t&&(t={}),function(e,r){var n=Reflect.getMetadata("HasMany",e)||[];n.push({propertyName:r,relationship:t.key||r}),Reflect.defineMetadata("HasMany",n,e)}},t.JsonApiDatastore=D,t.JsonApiDatastoreConfig=function(t){return void 0===t&&(t={}),function(e){Reflect.defineMetadata("JsonApiDatastoreConfig",t,e)}},t.JsonApiMetaModel=v,t.JsonApiModel=m,t.JsonApiModelConfig=function(t){return function(e){void 0!==t.meta&&null!=t.meta||(t.meta=v),Reflect.defineMetadata("JsonApiModelConfig",t,e)}},t.JsonApiModule=w,t.JsonApiNestedModel=p,t.JsonApiQueryData=R,t.JsonAttribute=function(t){return void 0===t&&(t={}),function(e,r){var n=function(e,r,n){var i;if(void 0===n&&(n=!1),t.converter)i=t.converter;else if(e===Date)i=new g;else{var a=new e;a.mask&&a.unmask&&(i=a)}return i?n?i.unmask(r):i.mask(r):r};delete e[r]&&(!function(){var n=Reflect.getMetadata("JsonAttribute",e)||{};n[r]={marked:!0},Reflect.defineMetadata("JsonAttribute",n,e);var i=Reflect.getMetadata("AttributeMapping",e)||{};i[void 0!==t.serializedName?t.serializedName:r]=r,Reflect.defineMetadata("AttributeMapping",i,e)}(),Object.defineProperty(e,r,{get:function(){return this.nestedDataSerialization?n(Reflect.getMetadata("design:type",e,r),this["_"+r],!0):this["_"+r]},set:function(t){var i=Reflect.getMetadata("design:type",e,r);this["_"+r]=n(i,t)},enumerable:!0,configurable:!0}))}},t.JsonModelConverter=h,t.NestedAttribute=function(t){return void 0===t&&(t={}),function(e,n){var i=function(e,r,n){var i;if(void 0===n&&(n=!1),t.converter)i=t.converter;else{var a=new e;a.mask&&a.unmask&&(i=a)}return i?n?i.unmask(r):i.mask(r):r};delete e[n]&&(!function(){var r=Reflect.getMetadata("NestedAttribute",e)||{};r[n]={marked:!0},Reflect.defineMetadata("NestedAttribute",r,e);var i=Reflect.getMetadata("AttributeMapping",e)||{};i[void 0!==t.serializedName?t.serializedName:n]=n,Reflect.defineMetadata("AttributeMapping",i,e)}(),Object.defineProperty(e,n,{get:function(){return this["_"+n]},set:function(t){var a=Reflect.getMetadata("design:type",e,n);this["_"+n]=i(a,t),function(t){var e=t["_"+n];if(t[y]||(t[y]={}),t[y][n]&&!t.isModelInitialization())t[y][n].newValue=e,t[y][n].hasDirtyAttributes=!r.isEqual(t[y][n].oldValue,e),t[y][n].serialisationValue=e;else{var a=r.cloneDeep(e);t[y][n]={newValue:e,oldValue:a,converter:i,nested:!0,hasDirtyAttributes:!r.isEqual(e,a)}}}(this)},enumerable:!0,configurable:!0}))}},t.PROVIDERS=O,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=angular2-jsonapi.umd.min.js.map